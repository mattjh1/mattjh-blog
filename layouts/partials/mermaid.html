{{ if .Store.Get "hasMermaid" }}
  <script type="module" async>
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.esm.min.mjs";

    mermaid.initialize({
      startOnLoad: true,
      theme: "base",
      themeVariables: {
        primaryColor: "#3B4252",
        primaryTextColor: "#D8DEE9",
        primaryBorderColor: "#4C566A",
        lineColor: "#88c0d0",
        secondaryColor: "#2E3440",
        tertiaryColor: "#4c566a",
      },
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
  <script>
    // Simple mobile detection
    function isMobile() {
      return window.innerWidth <= 768;
    }

    // Simplified zoom controller class
    class MermaidZoomController {
      constructor(container) {
        this.container = container;
        this.wrapper = container.querySelector(".mermaid-wrapper");
        this.mermaidEl = container.querySelector(".mermaid");
        this.panzoomInstance = null;

        this.waitForMermaidAndInit();
      }

      waitForMermaidAndInit() {
        const checkForSvg = () => {
          const svg = this.mermaidEl.querySelector("svg");
          if (svg) {
            this.setupResponsiveDisplay();
            if (!isMobile()) {
              this.initializePanzoom();
            } else {
              this.setupMobileView();
            }
          } else {
            setTimeout(checkForSvg, 100);
          }
        };

        setTimeout(checkForSvg, 200);
      }

      setupResponsiveDisplay() {
        // Update indicator text based on screen size
        const desktopText = this.container.querySelector('.pan-text.desktop-only');
        const mobileText = this.container.querySelector('.pan-text.mobile-only');
        
        if (isMobile()) {
          if (desktopText) desktopText.style.display = 'none';
          if (mobileText) mobileText.style.display = 'inline';
        } else {
          if (desktopText) desktopText.style.display = 'inline';
          if (mobileText) mobileText.style.display = 'none';
        }
      }

      setupMobileView() {
        // Enable native scrolling for mobile
        this.wrapper.style.overflow = 'auto';
        this.wrapper.style.webkitOverflowScrolling = 'touch';
        
        // Scale down SVG for mobile if needed
        const svg = this.mermaidEl.querySelector("svg");
        if (svg && window.innerWidth <= 480) {
          svg.style.transform = 'scale(0.9)';
          svg.style.transformOrigin = 'center top';
        }
      }

      initializePanzoom() {
        try {
          this.panzoomInstance = panzoom(this.mermaidEl, {
            maxScale: 3,
            minScale: 0.3,
            contain: "outside",
            smoothScroll: true,
            zoomDoubleClickSpeed: 1,
            bounds: true,
            boundsPadding: 0.2,
          });

          this.setupDesktopEventListeners();
        } catch (error) {
          console.warn('Panzoom initialization failed:', error);
        }
      }

      setupDesktopEventListeners() {
        if (!this.panzoomInstance) return;

        // Smooth wheel scrolling for desktop only
        this.wrapper.addEventListener("wheel", (e) => {
          if (isMobile() || !this.panzoomInstance) return;
          
          e.preventDefault();
          const delta = e.deltaY > 0 ? 0.9 : 1.1;
          
          try {
            this.panzoomInstance.zoomToPoint(this.panzoomInstance.getScale() * delta, e);
          } catch (error) {
            console.warn('Zoom failed:', error);
          }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
          this.handleResize();
        });
      }

      handleResize() {
        this.setupResponsiveDisplay();
        
        // If switching to mobile, destroy panzoom
        if (isMobile() && this.panzoomInstance) {
          this.panzoomInstance.dispose();
          this.panzoomInstance = null;
          this.setupMobileView();
        }
        // If switching to desktop and no panzoom, initialize it
        else if (!isMobile() && !this.panzoomInstance) {
          this.initializePanzoom();
        }
      }

      destroy() {
        if (this.panzoomInstance) {
          this.panzoomInstance.dispose();
        }
      }
    }

    // Initialize when DOM is ready
    document.addEventListener("DOMContentLoaded", () => {
      setTimeout(() => {
        const containers = document.querySelectorAll(".mermaid-container");
        containers.forEach((container) => {
          new MermaidZoomController(container);
        });
      }, 500);
    });
  </script>
{{ end }}
